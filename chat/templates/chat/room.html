<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>Chat Room</title>
    <style>
        div.scroll{
            background-color:#F9F3EE;
            width:90%;
            height:580PX;
            margin-left: 1%;
            padding: 1%;
            overflow-y:scroll;
        }
    </style>
</head>
<body>

<div id="chat-log" class="scroll">

    {% for message in messages %}
            <p>{{ message.sender_user }} : {{ message.message }}</p>
    {% endfor %}

</div>

<div style="margin-left: 1%; padding-top: 1%">
    <input id="chat-message-input" type="text" size="60" style="width: 80%">&nbsp;
    <input id="chat-message-submit" type="button" value="Send" style="width: 10%">
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

{{ room_name|json_script:"room-name" }}

<script>
    var sender = '{{ sender_id }}';
    var receiver = '{{ receiver_id }}';
    var sender_name = '{{ sender_name }}'

    console.log("-------------");
    console.log(sender);
    console.log(receiver);
    console.log(location['href'])
    console.log("-------------");

    const roomName = JSON.parse(document.getElementById('room-name').textContent);

    const chatSocket = new WebSocket(
        'wss://'
        + window.location.host
        + '/ws/chat/'
        + roomName
        + '/'
    );

    chatSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        console.log("-------------");
        console.log(data);
        console.log("-------------");


        $("#chat-log").append("<p>" + data.sender_name + " : " + data.message + "</p>");
        $("#chat-log").scrollTop($("#chat-log")[0].scrollHeight);

    };

    chatSocket.onclose = function (e) {
        console.error('Chat socket closed unexpectedly');
    };

    document.querySelector('#chat-message-input').focus();
    document.querySelector('#chat-message-input').onkeyup = function (e) {
        if (e.keyCode === 13) {  // enter, return
            document.querySelector('#chat-message-submit').click();
        }
    };

    document.querySelector('#chat-message-submit').onclick = function (e) {
        const messageInputDom = document.querySelector('#chat-message-input');
        const message = messageInputDom.value;

        if(message.trim().length !== 0) {
            chatSocket.send(JSON.stringify({
                'message': message,
                'sender': sender,
                'receiver': receiver,
                'sender_name': sender_name
            }));
            messageInputDom.value = '';
        }
    };


</script>
</body>
</html>